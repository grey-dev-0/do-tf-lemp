#! /bin/bash
set -e
set -o pipefail

echo 'Creating swap space...'
if ! swapon --show | grep -q '/swapfile'; then
  fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
  chmod 600 /swapfile
  mkswap /swapfile
  swapon /swapfile
  if ! grep -q '^/swapfile ' /etc/fstab; then
    echo '/swapfile none swap sw 0 0' >> /etc/fstab
  fi
  echo 'Swap created and enabled.'
else
  echo 'Swap already active.'
fi

echo 'Disabling SELinux...'
if command -v setenforce &> /dev/null; then
  setenforce 0 || true
  sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config || true
  echo 'SELinux disabled.'
else
  echo 'SELinux not available.'
fi

echo 'Initializing setup..'
for arg in "$@"; do
    if [[ "$arg" =~ ^-- ]]; then
        variable=$(echo $arg | sed 's/^--//')
    else
        declare $variable="$arg"
    fi
done
unalias cp || true
unalias mv || true
cd $(dirname "$0")
echo 'fastestmirror=1' >>/etc/dnf/dnf.conf
echo 'max_parallel_downloads=8' >>/etc/dnf/dnf.conf

echo 'Installing required software..'
groupadd --gid 9000 nginx || true
useradd -M --uid 9000 --gid 9000 nginx || true
yum update -y openssl openssh-server openssh-clients
yum install -y nginx nginx-mod-http-perl
yum install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm
dnf config-manager --set-enabled remi
mv resources/config/mariadb.repo /etc/yum.repos.d/
yum install -y php81 php81-php-bcmath php81-php-cli php81-php-common php81-php-fpm php81-php-gd php81-php-intl php81-php-json php81-php-mbstring php81-php-mysqlnd php81-php-pdo php81-php-pecl-geoip php81-php-pecl-imagick php81-php-pecl-zip php81-php-xml php81-runtime php81-php-process php81-php-opcache mariadb-server nodejs
ln -s -T /usr/bin/php81 /usr/bin/php
ln -s -T /opt/remi/php81/root/usr/sbin/php-fpm /usr/bin/php-fpm
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php composer-setup.php
php -r "unlink('composer-setup.php');"
mv composer.phar /usr/bin/composer
chmod +x /usr/bin/composer

echo 'Configuring required software..'
if [ -n "$server_domain" ]; then
    sed -i "s/__domain__/$server_domain/g" resources/config/app.conf
fi
if [ -n "$server_root" ]; then
    sed -i "s|__root_dir__|$server_root|g" resources/config/app.conf
fi
if [ -n "$db_password" ]; then
    sed -i "s/__db_password__/$db_password/g" resources/mariadb_init.sql
fi
if [ -n "$root_password" ]; then
    echo "root:$root_password" | chpasswd
fi
mv resources/config/nginx.conf /etc/nginx/
mv resources/config/app.conf /etc/nginx/conf.d/
mv resources/config/php-fpm.conf /etc/opt/remi/php81/
mv resources/config/www.conf /etc/opt/remi/php81/php-fpm.d/
systemctl enable nginx php81-php-fpm mariadb
systemctl start php81-php-fpm
systemctl start nginx mariadb
chown nginx:nginx /var/opt/remi/php81/run/php-fpm/www.sock
mysql < resources/mariadb_init.sql